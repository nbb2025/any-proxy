services:
  postgres:
    image: postgres:16-alpine
    container_name: any-proxy-postgres
    environment:
      POSTGRES_USER: ${PG_USER:-anyproxy}
      POSTGRES_PASSWORD: ${PG_PASSWORD:-anyproxy}
      POSTGRES_DB: ${PG_DATABASE:-anyproxy}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${PG_USER:-anyproxy} -d ${PG_DATABASE:-anyproxy}"]
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - "${PG_PORT:-5432}:5432"
    volumes:
      - ./pg-data:/var/lib/postgresql/data
    networks:
      - any-proxy

  etcd:
    image: quay.io/coreos/etcd:v3.5.15
    container_name: any-proxy-etcd
    command:
      - /usr/local/bin/etcd
      - --name=etcd0
      - --data-dir=/etcd-data
      - --advertise-client-urls=http://0.0.0.0:2379
      - --listen-client-urls=http://0.0.0.0:2379
      - --listen-peer-urls=http://0.0.0.0:2380
      - --initial-advertise-peer-urls=http://etcd:2380
      - --initial-cluster=etcd0=http://etcd:2380
      - --initial-cluster-state=new
      - --initial-cluster-token=any-proxy-etcd
    environment:
      ETCDCTL_API: "3"
    healthcheck:
      test:
        [
          "CMD",
          "etcdctl",
          "--endpoints=http://127.0.0.1:2379",
          "endpoint",
          "health",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - "${ETCD_CLIENT_PORT:-2379}:2379"
    volumes:
      - ./etcd-data:/etcd-data
    networks:
      - any-proxy

  control-plane:
    build:
      context: ..
      dockerfile: deploy/control-plane.Dockerfile
    image: any-proxy/control-plane:local
    depends_on:
      postgres:
        condition: service_healthy
      etcd:
        condition: service_healthy
    volumes:
      - ./configs:/configs:ro
      - ./deploy/pki:/app/pki:ro
      - ../install:/app/install:ro
    environment:
      CONTROL_PLANE_LISTEN: ${CONTROL_PLANE_LISTEN:-:8080}
      ETCD_ENDPOINTS: ${ETCD_ENDPOINTS:-http://etcd:2379}
      ETCD_PREFIX: ${ETCD_PREFIX:-/any-proxy/}
      CONTROL_PLANE_SEED: ${CONTROL_PLANE_SEED:-}
      ETCD_CERT: ${ETCD_CERT:-}
      ETCD_KEY: ${ETCD_KEY:-}
      ETCD_CA: ${ETCD_CA:-}
      ETCD_INSECURE_SKIP_VERIFY: ${ETCD_INSECURE_SKIP_VERIFY:-}
      PG_DSN: ${PG_DSN:-postgres://anyproxy:anyproxy@postgres:5432/anyproxy?sslmode=disable}
      PG_MAX_IDLE: ${PG_MAX_IDLE:-4}
      PG_MAX_OPEN: ${PG_MAX_OPEN:-16}
      PG_CONN_MAX_LIFETIME: ${PG_CONN_MAX_LIFETIME:-2h}
      AUTH_USERNAME: ${AUTH_USERNAME:?auth username required}
      AUTH_PASSWORD: ${AUTH_PASSWORD:?auth password required}
      AUTH_JWT_SECRET: ${AUTH_JWT_SECRET:?jwt secret required}
      AUTH_ACCESS_TOKEN_TTL: ${AUTH_ACCESS_TOKEN_TTL:-24h}
      AUTH_REFRESH_TOKEN_TTL: ${AUTH_REFRESH_TOKEN_TTL:-336h}
    entrypoint:
      - /bin/sh
      - -c
      - >
        exec /app/control-plane
        -listen "$${CONTROL_PLANE_LISTEN}"
        -etcd-endpoints "$${ETCD_ENDPOINTS}"
        -etcd-prefix "$${ETCD_PREFIX}"
        $${CONTROL_PLANE_SEED:+-seed $${CONTROL_PLANE_SEED}}
        $${ETCD_CERT:+-etcd-cert $${ETCD_CERT}}
        $${ETCD_KEY:+-etcd-key $${ETCD_KEY}}
        $${ETCD_CA:+-etcd-ca $${ETCD_CA}}
        $${ETCD_INSECURE_SKIP_VERIFY:+-etcd-insecure-skip-verify}
        $${PG_DSN:+-pg-dsn $${PG_DSN}}
        $${PG_MAX_IDLE:+-pg-max-idle $${PG_MAX_IDLE}}
        $${PG_MAX_OPEN:+-pg-max-open $${PG_MAX_OPEN}}
        $${PG_CONN_MAX_LIFETIME:+-pg-conn-max-lifetime $${PG_CONN_MAX_LIFETIME}}
    networks:
      - any-proxy

  frontend:
    build:
      context: ..
      dockerfile: deploy/frontend.Dockerfile
    image: any-proxy/frontend:local
    depends_on:
      control-plane:
        condition: service_started
    environment:
      CONTROL_PLANE_API_URL: ${CONTROL_PLANE_API_URL:-http://control-plane:8080}
      NEXT_PUBLIC_CONTROL_PLANE_URL: ${NEXT_PUBLIC_CONTROL_PLANE_URL:-}
      INSTALL_CONTROL_PLANE_URL: ${INSTALL_CONTROL_PLANE_URL:-}
      PORT: 3000
    networks:
      - any-proxy

  gateway:
    image: nginx:1.27-alpine
    depends_on:
      frontend:
        condition: service_started
      control-plane:
        condition: service_started
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/certs:/etc/nginx/certs:ro
    ports:
      - "80:80"
      - "443:443"
    networks:
      - any-proxy

networks:
  any-proxy:
    driver: bridge
