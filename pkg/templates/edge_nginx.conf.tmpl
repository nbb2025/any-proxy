# Generated by any-proxy - edge node {{ .NodeID }} at {{ .GeneratedAt }}
worker_processes auto;

events {
    worker_connections 4096;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile      on;
    tcp_nopush    on;
    keepalive_timeout 65;
    server_tokens off;

{{- range .Domains }}
    {{- $sslPolicy := sslPolicyFor $.SSLPolicies . }}
    {{- $cert := certificateFor $.Certificates .AccountID }}
    upstream {{ .UpstreamName }} {
{{- range .Upstreams }}
        server {{ .Address }}{{ if .Weight }} weight={{ .Weight }}{{ end }}{{ if .MaxFails }} max_fails={{ .MaxFails }}{{ end }}{{ if .FailTimeout }} fail_timeout={{ .FailTimeout }}{{ end }};
{{- if .HealthCheck }}
        # health_check: {{ .HealthCheck }}
{{- end }}
{{- end }}
{{- if .EnablePersist }}
        keepalive 64;
{{- end }}
    }

    server {
        listen 80;
{{- if .EnableTLS }}
        listen 443 ssl http2;
{{- if $cert }}
        ssl_certificate     {{ $cert.CertificatePath }};
{{- if $cert.KeyPath }}
        ssl_certificate_key {{ $cert.KeyPath }};
{{- end }}
{{- end }}
{{- end }}

        server_name {{ .Domain }};
        access_log /var/log/nginx/{{ .Domain }}.access.log main;

{{- if $sslPolicy }}
{{- if $sslPolicy.EnforceHTTPS }}
        if ($scheme = http) {
            return 301 https://$host$request_uri;
        }
{{- end }}
{{- if $sslPolicy.EnableHSTS }}
        add_header Strict-Transport-Security "max-age={{ hstsSeconds $sslPolicy.HSTSMaxAge }}{{ if $sslPolicy.HSTSIncludeSubdomains }}; includeSubDomains{{ end }}{{ if $sslPolicy.HSTSPreload }}; preload{{ end }}" always;
{{- end }}
{{- if $sslPolicy.MinTLSVersion }}
        ssl_protocols {{ tlsProtocols $sslPolicy.MinTLSVersion }};
{{- end }}
{{- if $sslPolicy.EnableOCSPStapling }}
        ssl_stapling on;
        ssl_stapling_verify on;
{{- end }}
{{- if $sslPolicy.ClientAuth }}
        ssl_verify_client on;
{{- end }}
{{- end }}

{{- if .Sticky }}
        sticky cookie srv_id expires=1h path=/;
{{- end }}
{{- if .ProxyTimeout }}
        proxy_connect_timeout {{ .ProxyTimeout }};
{{- end }}
{{- if .ReadTimeout }}
        proxy_read_timeout {{ .ReadTimeout }};
{{- end }}
{{- if .SendTimeout }}
        proxy_send_timeout {{ .SendTimeout }};
{{- end }}

        location / {
            proxy_pass http://{{ .UpstreamName }};
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
        }
    }
{{- end }}
}
